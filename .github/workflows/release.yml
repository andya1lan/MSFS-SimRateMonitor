name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
        
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: "auto"
        restore-cache: "true"
        save-cache: "true"
      
    - name: Install dependencies
      run: |
        uv sync
        
    - name: Download JetBrains Mono font
      run: |
        Invoke-WebRequest -Uri "https://github.com/JetBrains/JetBrainsMono/releases/download/v2.304/JetBrainsMono-2.304.zip" -OutFile "JetBrainsMono.zip"
        Expand-Archive -Path JetBrainsMono.zip -DestinationPath JetBrainsMono -Force
        New-Item -ItemType Directory -Force -Path fonts
        Copy-Item "JetBrainsMono\fonts\ttf\JetBrainsMono-Bold.ttf" "fonts\"
        Remove-Item JetBrainsMono.zip
        Remove-Item JetBrainsMono -Recurse
        
    - name: Build executable
      run: |
        .\build.bat
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true
        files: ./dist/MSFS-SimRate-Monitor.exe